name: Patch all recovery.img files

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  patch_all:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install runtime dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends lz4 tar gzip ca-certificates curl

      - name: Make tools and scripts executable
        run: |
          chmod +x ./script1.sh || true
          chmod +x ./script2.sh || true
          [ -f ./magiskboot ] && chmod +x ./magiskboot
          [ -f ./avbtool ] && chmod +x ./avbtool

      - name: Run preparer / patch scripts if present
        run: |
          set -euo pipefail
          if [ -f ./script1.sh ]; then
            echo "Running ./script1.sh"
            ./script1.sh
          else
            echo "script1.sh not found â€” skipping"
          fi

          if [ -f ./script2.sh ]; then
            echo "Running ./script2.sh"
            ./script2.sh
          else
            echo "script2.sh not found â€” skipping"
          fi

      - name: Detect produced .img outputs (exclude original recovery.img)
        id: detect
        run: |
          set -euo pipefail
          # find all .img files excluding the original recovery.img in repo root and .github
          mapfile -t IMS < <(find . -type f -name '*.img' ! -path './.github/*' ! -name 'recovery.img' -print | sed 's|^\./||' | sort -u)
          if [ "${#IMS[@]}" -eq 0 ]; then
            echo "No produced .img files found."
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi
          printf "%s " "${IMS[@]}" > imgs.txt
          echo "files=$(cat imgs.txt)" >> $GITHUB_OUTPUT

      - name: Show checksums for produced images
        if: ${{ steps.detect.outputs.files != '' }}
        run: |
          set -euo pipefail
          read -r -a FILES <<< "${{ steps.detect.outputs.files }}"
          for f in "${FILES[@]}"; do
            echo "---- $f ----"
            ls -lh "$f" || true
            sha256sum "$f" || true
          done

      - name: Package produced images into a single tar.gz artifact
        if: ${{ steps.detect.outputs.files != '' }}
        run: |
          set -euo pipefail
          rm -rf patched_outputs
          mkdir -p patched_outputs
          read -r -a FILES <<< "${{ steps.detect.outputs.files }}"
          for f in "${FILES[@]}"; do
            # copy preserving dirs when possible; fallback to basename
            cp --parents "$f" patched_outputs/ 2>/dev/null || cp "$f" "patched_outputs/$(basename "$f")"
          done
          tar -C patched_outputs -czf patched_outputs.tar.gz .
          ls -lh patched_outputs.tar.gz

      - name: Upload patched outputs artifact
        if: ${{ steps.detect.outputs.files != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: patched-outputs
          path: patched_outputs.tar.gz

      - name: Debug when no outputs were produced
        if: ${{ steps.detect.outputs.files == '' }}
        run: |
          echo "No patched outputs produced. Listing .img files and showing scripts for debugging:"
          find . -maxdepth 4 -type f -name '*.img' -print -exec ls -lh {} \; || true
          [ -f script1.sh ] && sed -n '1,200p' script1.sh || true
          [ -f script2.sh ] && sed -n '1,200p' script2.sh || true
