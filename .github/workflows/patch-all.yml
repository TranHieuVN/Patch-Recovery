name: Patch all recovery.img files (safe-run)

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  patch_all:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install required packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends lz4 tar gzip ca-certificates curl file

      - name: Make scripts and binaries executable
        run: |
          chmod +x ./script1.sh 2>/dev/null || true
          chmod +x ./script2.sh 2>/dev/null || true
          if [ -f ./magiskboot ]; then chmod +x ./magiskboot; fi
          if [ -f ./avbtool ]; then chmod +x ./avbtool; fi

      - name: Diagnostics: list repo and check binaries
        run: |
          echo "Repo root:"
          ls -la
          echo "Find .img files and types:"
          find . -type f -name '*.img' -print -exec file {} \; || true
          if [ -f ./magiskboot ]; then
            echo "magiskboot details:"
            file ./magiskboot || true
            ldd ./magiskboot 2>&1 || true
          fi

      - name: Run preparer and patch scripts (if present)
        run: |
          set -euo pipefail
          if [ -f ./script1.sh ]; then
            echo "Running ./script1.sh"
            ./script1.sh
          else
            echo "script1.sh missing; skipping"
          fi

          if [ -f ./script2.sh ]; then
            echo "Running ./script2.sh"
            ./script2.sh
          else
            echo "script2.sh missing; skipping"
          fi

      - name: Detect produced .img outputs
        id: detect
        run: |
          set -euo pipefail
          # Find produced .img files, exclude workflow dir and original recovery.img
          mapfile -t OUTS < <(find . -type f -name '*.img' ! -path './.github/*' ! -name 'recovery.img' -print | sed 's|^\./||' | sort -u)
          if [ "${#OUTS[@]}" -eq 0 ]; then
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi
          printf "%s " "${OUTS[@]}" > imgs.txt
          echo "files=$(cat imgs.txt)" >> $GITHUB_OUTPUT

      - name: Show outputs and checksums
        if: ${{ steps.detect.outputs.files != '' }}
        run: |
          read -r -a FILES <<< "${{ steps.detect.outputs.files }}"
          for f in "${FILES[@]}"; do
            echo "---- $f ----"
            ls -lh "$f" || true
            sha256sum "$f" || true
          done

      - name: Package outputs
        if: ${{ steps.detect.outputs.files != '' }}
        run: |
          rm -rf patched_outputs || true
          mkdir -p patched_outputs
          read -r -a FILES <<< "${{ steps.detect.outputs.files }}"
          for f in "${FILES[@]}"; do
            cp --parents "$f" patched_outputs/ 2>/dev/null || cp "$f" "patched_outputs/$(basename "$f")"
          done
          tar -C patched_outputs -czf patched_outputs.tar.gz .
          ls -lh patched_outputs.tar.gz

      - name: Upload artifact
        if: ${{ steps.detect.outputs.files != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: patched-outputs
          path: patched_outputs.tar.gz

      - name: Debug info when no outputs
        if: ${{ steps.detect.outputs.files == '' }}
        run: |
          echo "No outputs produced; printing diagnostics"
          find . -maxdepth 4 -type f -name '*.img' -print -exec ls -lh {} \; || true
          [ -f script1.sh ] && sed -n '1,200p' script1.sh || true
          [ -f script2.sh ] && sed -n '1,200p' script2.sh || true
